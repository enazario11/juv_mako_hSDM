---
title: "Mako hSDM BRT explore (CRW PAs)"
author: "Emily Nazario"
date: "`r Sys.Date()`"
format:
 html: 
  self-contained: true
editor: visual
toc: TRUE
toc-title: "On this page"
theme: yeti
fontcolor: "#134f5c"
code-block-bg: true
---

On this document, I've included the results from the initial exploration into the different model outputs, ranking of covariate influence, performance metrics, and prediction maps.

The majority of the predictors included in the following models are at a daily temporal resolution. However, for the DO and AGI models, we also investigated the inclusion of these two predictors at seasonal and annual temporal resolutions. The remaining environmental predictors are also available at these resolutions, and can included in follow-up models.

The pseudo absences used in these models were generated using correlated random walk approaches, but another quarto document includes models with background sampling pseudo absences. Lastly, hyperparameters were tuned using the caret package and across all models, a learning rate of 0.05 and tree complexity of 3 resulted in the highest accuracy. Lastly, the 'pred_var' predictor is a random set of numbers that will be used to identify which predictor variables should be included in the final model, and which are not informative.

The hypotheses I would like to test with these models are as follows:

**H1:** The AGI model will perform better than the dissolved oxygen and null model, and the dissolved oxygen model will perform better than the null model.

*study objective being met:* Which model performs the best and presents the best predictions (i.e., best predictive performance scores, most ecologically realistic suitability maps)?

**H2:** The inclusion of dissolved oxygen at deeper depths will result in better/more ecologically realistic habitat suitability predictions relative to the dissolved oxygen model considering surface values alone.

*study objective being met:* How does dissolved oxygen at different depths influence habitat suitability predictions relative to oxygen at the surface?

**H3:** The inclusion of the AGI at deeper depths will result in better/more ecologically realistic habitat suitability predictions relative to the AGI model considering surface values alone.

*study objective being met:* How does the aerobic growth index (AGI; environmental oxygen supply:theoretical oxygen demand) at different depths influence habitat suitability predictions relative to the aerobic growth index at the surface?

**H4:** There will be important relationships between dissolved oxygen/the AGI and latitude/distance to coast.

*study objective being met:* Are there any important relationships between dissolved oxygen or AGI at the surface or at depth and latitude or distance to the coast?

**H5:** The null model will predict higher habitat suitability in areas or during seasons or periods (upwelling or La Ni√±a) with lower dissolved oxygen through the water column relative to the dissolved oxygen and AGI models.

*study objective being met:* How do the habitat suitability maps differ between the models? How do these variations compare for different points in time?

```{r}
#| echo: false
#| warning: false
#| message: false
#| include: false

#libraries
library(tidyverse)
library(gbm)
library(dismo)
library(here)
library(terra)
library(sf)
library(tidyterra)
library(here);here <- here::here #plyr's here function masks here::here

set.seed(1004)

source(here("functions/BRT_evaluation_functions.R"))
source(here("functions/brt_explore_quarto_function.R"))

#load BRT outputs (daily tag and no tag files only)
brt_outputs <- list.files(here("data/brt/mod_outputs/crw"), full.names = TRUE, pattern = ".rds")
brt_outputs_Ntag <- list.files(here("data/brt/mod_outputs/crw/no_tag"), full.names = TRUE)

#load test datasets
base_test_daily <- readRDS(here("data/brt/mod_eval/base_test_daily.rds"))
base_test_seasonal <- readRDS(here("data/brt/mod_eval/base_test_seasonal.rds"))
base_test_annual <- readRDS(here("data/brt/mod_eval/base_test_annual.rds"))

do_test_daily <- readRDS(here("data/brt/mod_eval/do_test_daily.rds"))
agi_test_daily <- readRDS(here("data/brt/mod_eval/agi_test_daily.rds"))

do_test_daily_seasonal_annual <- readRDS(here("data/brt/mod_eval/do_test_daily_seasonal_annual.rds"))
agi_test_daily_seasonal_annual <- readRDS(here("data/brt/mod_eval/agi_test_daily_seasonal_annual.rds"))

```

# Base models

These three models represent three different options for the base model and either include spatial predictors, a tag ID predictor, both, or neither. These models were developed by splitting the data set into 75/25 train/test, and thus that is the model evaluation approach used here. However, once a model is selected, I can run additional evaluation metrics (i.e., LOO, k-fold). I can also complete these now depending on when that is typically performed.

::: panel-tabset
## 0m, no spatial predictors, no tag ID predictor

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs[7], 
            test_data = base_test_daily)

```

## 0m, no spatial predictors, yes tag ID predictor

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs[8], 
            test_data = base_test_daily)
```

## 0m, yes spatial predictors, yes tag ID predictor

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs[9], 
            test_data = base_test_daily)

```
:::

# DO models

I ran a suite of models that include various combinations of data at depth, spatial predictors, and tag ID predictors. Moving forward, I would also like to include DO and the other environmental predictor variables as longer time scales (seasonal/annual).

::: panel-tabset
## 0m, no spatial, yes tag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs[14], 
            test_data = do_test_daily)

```

## 0m, yes spatial, yes tag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs[15], 
            test_data = do_test_daily)

```

## 0m & 60m, no spatial, yes tag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs[13], 
            test_data = do_test_daily)

```

## 0m & 250m, no spatial, yes tag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs[10], 
            test_data = do_test_daily)

```

## 0m, 60m, & 250m, no spatial, yes tag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs[11], 
            test_data = do_test_daily)

```

## 0m, 60m, & 250m, yes spatial, yes tag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs[12], 
            test_data = do_test_daily)

```
:::

# AGI models

I ran a suite of models that include various combinations of data at depth, spatial predictors, and tag ID predictors. Moving forward, I would also like to include AGI and the other environmental predictor variables as longer time scales (seasonal/annual).

::: panel-tabset
## 0m, no spatial, yes tag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs[5], 
            test_data = agi_test_daily)

```

## 0m, yes spatial, yes tag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs[6], 
            test_data = agi_test_daily)

```

## 0m & 60m, no spatial, yes tag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs[4], 
            test_data = agi_test_daily)

```

## 0m & 250m, no spatial, yes tag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs[1], 
            test_data = agi_test_daily)

```

## 0m, 60m, & 250m, no spatial, yes tag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs[2], 
            test_data = agi_test_daily)

```

## 0m, 60m, & 250m, yes spatial, yes tag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs[3], 
            test_data = agi_test_daily)

```
:::

# Summary table of results

```{r}
#| warning: false
#| message: false

output_sum <- read.csv(here("data/brt/mod_outputs/brt_crw_output_summary.csv"))
kableExtra::kable(output_sum)

```

```{r}
#| warning: false
#| message: false

# ggplot(output_sum, aes(AUC, TSS, color = deviance_exp, label = model)) + 
#   geom_point(size = 3) +
#   xlab('AUC') +
#   ylab('TSS') +
#   scale_color_gradientn(colors = MetBrewer::met.brewer("Greek")) +
#   ggrepel::geom_label_repel(aes(label = model),
#                   box.padding   = 0.35, 
#                   point.padding = 0.5,
#                   segment.color = 'grey50')
```

# DO models w/o tag ID

Here, I have run the same models as above, but without tag ID as a predictor variable. For this chunk of models, I am interested in identifying the role that dissolved oxygen may play in habitat suitability predictions, and how its relative importance compares to other covariates that are typically included in SDMs. Additionally, as BRTs are nonparametric, it is not critical or necessary for tag ID to be included.

::: panel-tabset
## 0m, no spatial, no tag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs_Ntag[12], 
            test_data = do_test_daily)

```

## 0m, yes spatial, no tag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs_Ntag[13], 
            test_data = do_test_daily)

```

## 0m & 60m, no spatial, no tag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs_Ntag[11], 
            test_data = do_test_daily)

```

## 0m & 250m, no spatial, no tag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs_Ntag[8], 
            test_data = do_test_daily)

```

## 0m, 60m, & 250m, no spatial, no tag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs_Ntag[9], 
            test_data = do_test_daily)

```

## 0m, 60m, & 250m, yes spatial, no tag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs_Ntag[10], 
            test_data = do_test_daily)

```
:::

# AGI models w/o tag ID

Here, I have run the same models as above, but without tag ID as a predictor variable. For this chunk of models, I am interested in identifying the role that AGI may play in habitat suitability predictions, and how its relative importance compares to other covariates that are typically included in SDMs. Additionally, as BRTs are nonparametric, it is not critical or necessary for tag ID to be included.

::: panel-tabset
## 0m, no spatial, no tag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs_Ntag[5], 
            test_data = agi_test_daily)

```

## 0m, yes spatial, no tag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs_Ntag[6], 
            test_data = agi_test_daily)

```

## 0m & 60m, no spatial, no tag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs_Ntag[4], 
            test_data = agi_test_daily)

```

## 0m & 250m, no spatial, no tag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs_Ntag[1], 
            test_data = agi_test_daily)

```

## 0m, 60m, & 250m, no spatial, no tag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs_Ntag[2], 
            test_data = agi_test_daily)

```

## 0m, 60m, & 250m, yes spatial, no tag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = brt_outputs_Ntag[3], 
            test_data = agi_test_daily)

```
:::

# Summary table of results

```{r}
#| warning: false
#| message: false

output_sum_Ntag <- read.csv(here("data/brt/mod_outputs/brt_crw_output_summary_Ntag.csv"))
kableExtra::kable(output_sum_Ntag)

```

```{r}
#| warning: false
#| message: false

# ggplot(output_sum_Ntag, aes(AUC, TSS, color = deviance_exp, label = model)) + 
#   geom_point(size = 3) +
#   xlab('AUC') +
#   ylab('TSS') +
#   scale_color_gradientn(colors = MetBrewer::met.brewer("Greek")) +
#   ggrepel::geom_label_repel(aes(label = model),
#                   box.padding   = 0.35, 
#                   point.padding = 0.5,
#                   segment.color = 'grey50')
```

# Base models w/o tag ID and w/ data at seasonal and annual resolutions

For these models, the environmental raster data was averaged according to season and year. Observed and pseudo absence locations were then used for environmental data extraction along these raster files and were matched to each file according to either the season or year.

::: panel-tabset
## Seasonal resolution

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = "data/brt/mod_outputs/crw/seasonal/brt_base_0m_seas_Nspat_Ntag.rds",
            test_data = base_test_seasonal)

```

## Annual resolution

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = "data/brt/mod_outputs/crw/annual/brt_base_0m_ann_Nspat_Ntag.rds",
            test_data = base_test_annual)
```
:::

# DO models w/o tag ID and w/ data at seasonal and annual resolutions

::: panel-tabset
## Seasonal, Nspat, Ntag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = "data/brt/mod_outputs/crw/seasonal/brt_do_0m_60m_250m_seas_Nspat_Ntag.rds",
            test_data = do_test_daily_seasonal_annual)

```

## Seasonal, Yspat, Ntag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = "data/brt/mod_outputs/crw/seasonal/brt_do_0m_60m_250m_seas_Yspat_Ntag.rds",
            test_data = do_test_daily_seasonal_annual)

```

## Annual, Nspat, Ntag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = "data/brt/mod_outputs/crw/annual/brt_do_0m_60m_250m_ann_Nspat_Ntag.rds",
            test_data = do_test_daily_seasonal_annual)

```

## Annual, Yspat, Ntag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = "data/brt/mod_outputs/crw/annual/brt_do_0m_60m_250m_ann_Yspat_Ntag.rds",
            test_data = do_test_daily_seasonal_annual)

```

## Daily, seasonal, and Annual, Nspat, Ntag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = "data/brt/mod_outputs/crw/annual/brt_do_0m_60m_250m_dail_seas_ann_Nspat_Ntag.rds",
            test_data = do_test_daily_seasonal_annual)

```

## Daily, Seasonal, and Annual, Yspat, Ntag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = "data/brt/mod_outputs/crw/annual/brt_do_0m_60m_250m_dail_seas_ann_Yspat_Ntag.rds",
            test_data = do_test_daily_seasonal_annual)

```
:::

# AGI models w/o tag ID and w/ data at seasonal and annual resolutions

::: panel-tabset
## Seasonal, Nspat, Ntag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = "data/brt/mod_outputs/crw/seasonal/brt_agi_0m_60m_250m_seas_Nspat_Ntag.rds",
            test_data = agi_test_daily_seasonal_annual)

```

## Seasonal, Yspat, Ntag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = "data/brt/mod_outputs/crw/seasonal/brt_agi_0m_60m_250m_seas_Yspat_Ntag.rds",
            test_data = agi_test_daily_seasonal_annual)

```

## Annual, Nspat, Ntag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = "data/brt/mod_outputs/crw/annual/brt_agi_0m_60m_250m_ann_Nspat_Ntag.rds",
            test_data = agi_test_daily_seasonal_annual)

```

## Annual, Yspat, Ntag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = "data/brt/mod_outputs/crw/annual/brt_agi_0m_60m_250m_ann_Yspat_Ntag.rds",
            test_data = agi_test_daily_seasonal_annual)

```

## Daily, seasonal, and Annual, Nspat, Ntag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = "data/brt/mod_outputs/crw/annual/brt_agi_0m_60m_250m_dail_seas_ann_Nspat_Ntag.rds",
            test_data = agi_test_daily_seasonal_annual)

```

## Daily, Seasonal, and Annual, Yspat, Ntag

```{r}
#| warning: false
#| fig-width: 12
#| fig-height: 10

explore_brt(mod_file_path = "data/brt/mod_outputs/crw/annual/brt_agi_0m_60m_250m_dail_seas_ann_Yspat_Ntag.rds",
            test_data = agi_test_daily_seasonal_annual)

```
:::

# Summary table of results

```{r}
#| warning: false
#| message: false

output_sum_seas_ann <- read.csv(here("data/brt/mod_outputs/brt_crw_seas_ann_output_summary.csv"))
kableExtra::kable(output_sum_seas_ann)
```

```{r}
#| warning: false
#| message: false

# ggplot(output_sum_seas_ann, aes(AUC, TSS, color = deviance_exp, label = model)) + 
#   geom_point(size = 3) +
#   xlab('AUC') +
#   ylab('TSS') +
#   scale_color_gradientn(colors = MetBrewer::met.brewer("Greek")) +
#   ggrepel::geom_label_repel(aes(label = model),
#                   box.padding   = 0.35, 
#                   point.padding = 0.5,
#                   segment.color = 'grey50')
```
